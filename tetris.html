<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      .main {
        display: flex;
        justify-content: center;
      }

      canvas {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <div class="main">
      <button id="test" onclick="onClickTestButton();">스탑</button>
      <canvas id="canvas" width="295" height="745"></canvas>
    </div>
    <script>
      const canvas = document.getElementById("canvas");

      const ctx = canvas.getContext("2d");

      const timePerLine = 100;

      const borderWidth = 5;
      const blockSize = 25;
      const widthBlockCount = 10;
      const heightBlockCount = 25;
      const topMargin = 0;

      let stackedBlocks = new Array(widthBlockCount);
      let controlBlocks = new Array(widthBlockCount);

      initBlockArray(stackedBlocks);
      initBlockArray(controlBlocks);

      controlBlocks[6][0] = true;
      controlBlocks[5][0] = true;
      controlBlocks[4][0] = true;
      controlBlocks[5][1] = true;

      drawBlocks();

      function initBlockArray(blockArray) {
        for (let x = 0; x < widthBlockCount; x++) {
          blockArray[x] = new Array(heightBlockCount);
        }

        clearBlockArray(blockArray);
      }

      function clearBlockArray(blockArray) {
        for (let x = 0; x < widthBlockCount; x++) {
          for (let y = 0; y < heightBlockCount; y++) {
            blockArray[x][y] = false;
          }
        }
      }

      function drawBlocks() {
        for (let x = 0; x < widthBlockCount; x++) {
          for (let y = 0; y < heightBlockCount; y++) {
            if (stackedBlocks[x][y]) {
              ctx.fillStyle = "black";
            } else {
              ctx.fillStyle = "gray";
            }

            if (controlBlocks[x][y]) {
              ctx.fillStyle = "blue";
            }

            ctx.fillRect(
              borderWidth * x + blockSize * x,
              borderWidth * y + blockSize * y + topMargin,
              blockSize,
              blockSize
            );
          }
        }
      }

      let testButtonOn = false;
      let timeId = null;

      function onClickTestButton() {
        if (testButtonOn) {
          clearInterval(timeId);
        } else {
          timeId = setInterval(flowGravity, timePerLine);
        }
        testButtonOn = !testButtonOn;
      }

      function flowGravity() {
        let collisionCheckTmpArray = copyBlockArray(controlBlocks);
        if (isCollided(collisionCheckTmpArray, stackedBlocks)) {
          addBlocksToStackedArray(controlBlocks, stackedBlocks);
          addNewControlBlock(controlBlocks);
        } else {
          controlBlocks = collisionCheckTmpArray;
        }

        // for (let x = 0; x < widthBlockCount; x++) {
        //   for (let y = heightBlockCount - 1; y != 0; y--) {
        //     controlBlocks[x][y] = controlBlocks[x][y - 1];
        //   }
        //   controlBlocks[x][0] = false;
        // }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBlocks();
      }

      function copyBlockArray(blockArray) {
        let tmpArray = new Array(widthBlockCount);
        for (let x = 0; x < widthBlockCount; x++) {
          tmpArray[x] = blockArray[x].slice();
        }
        return tmpArray;
      }

      function isCollided(collisionCheckTmpArray, stackedBlocks) {
        if (isReachToBottom(collisionCheckTmpArray)) {
          return true;
        }

        moveToBottomOneLine(collisionCheckTmpArray);

        for (let x = 0; x < widthBlockCount; x++) {
          for (let y = heightBlockCount - 1; y != 0; y--) {
            if (collisionCheckTmpArray[x][y] && stackedBlocks[x][y]) {
              return true;
            }
          }
        }

        return false;
      }

      function isReachToBottom(blockArray) {
        for (let x = 0; x < widthBlockCount; x++) {
          if (blockArray[x][heightBlockCount - 1]) {
            return true;
          }
        }
        return false;
      }

      function moveToBottomOneLine(blockArray) {
        for (let x = 0; x < widthBlockCount; x++) {
          for (let y = heightBlockCount - 1; y != 0; y--) {
            blockArray[x][y] = blockArray[x][y - 1];
          }
          blockArray[x][0] = false;
        }
      }

      function addBlocksToStackedArray(controlBlocks, stackedBlocks) {
        for (let x = 0; x < widthBlockCount; x++) {
          for (let y = heightBlockCount - 1; y != 0; y--) {
            if (controlBlocks[x][y]) {
              stackedBlocks[x][y] = true;
            }
          }
        }
      }

      function addNewControlBlock(controlBlocks) {
        //initBlockArray(controlBlocks);
        clearBlockArray(controlBlocks);
        let type = Math.floor(Math.random() * 6 + 1);

        switch (type) {
          case 1:
            addTypeOneBlock();
            break;
          case 2:
            addTypeTwoBlock();
            break;
          case 3:
            addTypeThreeBlock();
            break;
          case 4:
            addTypeFourBlock();
            break;
          case 5:
            addTypeFiveBlock();
            break;
          case 6:
            addTypeSixBlock();
            break;
        }
      }

      /**
       ****□□□□****
       **/
      function addTypeOneBlock() {
        controlBlocks[4][0] = true;
        controlBlocks[5][0] = true;
        controlBlocks[6][0] = true;
        controlBlocks[7][0] = true;
      }

      /**
       ****□□□*****
       *****□******
       **/
      function addTypeTwoBlock() {
        controlBlocks[4][0] = true;
        controlBlocks[5][0] = true;
        controlBlocks[5][1] = true;
        controlBlocks[6][0] = true;
      }

      /**
       *****□□*****
       *****□□*****
       **/
      function addTypeThreeBlock() {
        controlBlocks[4][0] = true;
        controlBlocks[4][1] = true;
        controlBlocks[5][0] = true;
        controlBlocks[5][1] = true;
      }

      /**
       ****□□******
       *****□□*****
       **/
      function addTypeFourBlock() {
        controlBlocks[4][0] = true;
        controlBlocks[5][0] = true;
        controlBlocks[5][1] = true;
        controlBlocks[6][1] = true;
      }

      /**
       *****□□*****
       ****□□******
       **/
      function addTypeFourBlock() {
        controlBlocks[4][1] = true;
        controlBlocks[5][0] = true;
        controlBlocks[5][1] = true;
        controlBlocks[6][0] = true;
      }

      /**
       ****□□□****
       ******□****
       **/
      function addTypeFiveBlock() {
        controlBlocks[4][0] = true;
        controlBlocks[5][0] = true;
        controlBlocks[6][0] = true;
        controlBlocks[6][1] = true;
      }

      /**
       ****□□□****
       ****□*******
       **/
      function addTypeSixBlock() {
        controlBlocks[4][0] = true;
        controlBlocks[4][1] = true;
        controlBlocks[5][0] = true;
        controlBlocks[6][0] = true;
      }
    </script>
  </body>
</html>
